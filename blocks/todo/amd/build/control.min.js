define(["jquery","core/log","core/ajax","core/templates"],function(a,b,c,d){"use strict";function e(c){b.debug("block_todo/control: initializing controls of the todo block instance "+c);var d=a('[data-region="block_todo-instance-'+c+'"]').first();if(!d.length)return void b.error("block_todo/control: wrapping region not found!");var e=new f(d);e.main()}function f(a){var b=this;b.region=a}return f.prototype.main=function(){var a=this;a.addTextForm=a.region.find('[data-control="addform"]').first(),a.addTextInput=a.addTextForm.find("input").first(),a.addTextButton=a.addTextForm.find("button").first(),a.itemsList=a.region.find("ul").first(),a.initAddFeatures(),a.initEditFeatures()},f.prototype.initAddFeatures=function(){var a=this;a.addTextForm.on("submit",function(b){b.preventDefault(),a.addNewTodo()}),a.addTextButton.on("click",function(){a.addTextForm.submit()})},f.prototype.initEditFeatures=function(){var b=this;b.itemsList.on("click","[data-item]",function(c){c.preventDefault(),c.stopPropagation();var d=a(c.currentTarget).attr("data-item");b.toggleItem(d)}),b.itemsList.on("click",'[data-control="delete"]',function(c){c.preventDefault(),c.stopPropagation();var d=a(c.currentTarget).closest("[data-item]").attr("data-item");b.deleteItem(d)})},f.prototype.addNewTodo=function(){var e=this,f=a.trim(e.addTextInput.val());return f?(e.addTextInput.prop("disabled",!0),c.call([{methodname:"block_todo_add_item",args:{todotext:f}}])[0].fail(function(c){return b.error("block_todo/control: unable to add the item"),b.debug(c),e.addTextButton.addClass("btn-danger"),e.addTextButton.html('<i class="fa fa-exclamation-circle" aria-hidden="true"></i>'),a.Deferred().reject()}).then(function(a){return d.render("block_todo/item",a).fail(function(a){b.error("block_todo/control: unable to render the new item:"+a)})}).then(function(b){return e.itemsList.prepend(b),e.addTextInput.val(""),e.addTextInput.prop("disabled",!1),e.addTextInput.focus(),a.Deferred().resolve()})):a.Deferred().resolve()},f.prototype.toggleItem=function(e){var f=this;return e?c.call([{methodname:"block_todo_toggle_item",args:{id:e}}])[0].fail(function(c){return b.error("block_todo/control: unable to toggle the item"),b.debug(c),a.Deferred().reject()}).then(function(a){return d.render("block_todo/item",a).fail(function(a){b.error("block_todo/control: unable to render the new item:"+a)})}).then(function(b){return f.itemsList.find('[data-item="'+e+'"]').replaceWith(b),a.Deferred().resolve()}):a.Deferred().resolve()},f.prototype.deleteItem=function(d){var e=this;return d?c.call([{methodname:"block_todo_delete_item",args:{id:d}}])[0].fail(function(c){return b.error("block_todo/control: unable to delete the item"),b.debug(c),a.Deferred().reject()}).then(function(b){return e.itemsList.find('[data-item="'+b+'"]').remove(),a.Deferred().resolve()}):a.Deferred().resolve()},{init:e}});